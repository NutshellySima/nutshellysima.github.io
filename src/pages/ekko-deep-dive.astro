---
import BaseLayout from '../layouts/BaseLayout.astro';

const navItems = [
  { href: '/', label: 'Overview page', icon: 'home' },
  { href: '/deep-dive', label: 'Technical notes', icon: 'activity' },
  { href: '#challenge', label: 'Challenge', icon: 'target' },
  { href: '#pipeline', label: 'Pipeline', icon: 'workflow' },
  { href: '#dissemination', label: 'Dissemination', icon: 'send' },
  { href: '#storage', label: 'Storage', icon: 'database' },
  { href: '#safety', label: 'Safety', icon: 'shield-check' },
  { href: '#impact', label: 'Impact', icon: 'bar-chart-3' },
];

const scalingContext = [
  'WeChat DLRS supports short videos, games, passages, and e-shop workloads.',
  'User growth moved from millions to over one billion.',
  'Content supply reached billions of short videos.',
  'Training data exceeded 10 billion samples per day.',
  'User action sequence length grew beyond 10,000.',
];

const projectTargets = [
  'Scale individual models from a few GB to tens of TB (about 10,000x).',
  'Support 10,000+ simultaneous models for large A/B experiment spaces.',
  'Keep model freshness in geo-distributed serving under strict SLOs.',
];

const systemModel = [
  'Embedding tables dominate model size (tens of TB); DNN blocks are typically GB level.',
  'Parameters are stored in geo-distributed parameter servers for low-latency inference and local fault tolerance.',
  'Update loop: collect training data -> train online -> disseminate updates -> serve inference.',
];

const traditionalPath = ['Checkpoint', 'Validation', 'Broadcast', 'Serve'];
const ekkoPath = ['Online training updates', 'Leaderless P2P sync', 'SLO-aware scheduling', 'Serve with rollback guard'];

const disseminationHighlights = [
  'Version-vector synchronization removes a central leader bottleneck.',
  'Overlay-friendly P2P exchange uses available WAN paths.',
  'Only necessary parameters are transferred between replicas.',
  'Dominator Version Vector (DVV) summarizes non-cached keys and cuts comparison cost from O(N) to O(Nr), where Nr << N.',
];

const disseminationStats = [
  'Only 0.13% to 0.2% of parameters kept in cache in production.',
  'Cache hit ratio around 99.4% in production.',
  'About 7x faster dissemination than Project Adam in a 10-DC evaluation setting.',
];

const schedulerSignals = [
  {
    title: 'Freshness signal',
    detail: 'Policy-admitted urgent parameters are treated as highest priority.',
  },
  {
    title: 'Gradient significance signal',
    detail: 'Larger normalized gradient magnitude implies larger expected impact.',
  },
  {
    title: 'Model traffic signal',
    detail: 'Models with higher request share get higher update priority.',
  },
];

const schedulerOutcomes = [
  'Network usage reduced by about 92% without visible quality degradation in reported results.',
  'SLO drops were reduced versus non-prioritized dissemination.',
  'Later production refinement used loss-estimate windows to prioritize updates more directly.',
];

const storageObjectives = [
  'Load balancing across CPU, memory, and network resources.',
  'Strict capacity constraints during scheduling and rescheduling.',
  'System stability by minimizing data migration.',
  'Low-latency inference by limiting over-fragmented table span.',
  'Scalability and reservation by capping per-node footprint of each model.',
];

const storageOutcomes = [
  'Naive MILP construction can explode to billions of variables and constraints.',
  'Variable reduction (x_{p,s} to d_{t,s} style aggregation) and heuristics improved solve time.',
  'Solver produced satisfactory plans in about 180 seconds in reported production usage.',
  'Storage cost reduction reached about 49% versus Slicer baseline in reported comparison.',
];

const safetyTriggers = ['Gradient overflow under low precision training.', 'Biased or outlier data from the data pipeline.', 'Skipped validation stage in low-latency path can surface harmful updates online.'];

const safetyOutcomes = [
  'Baseline models are used as clean references for health monitoring.',
  'Usually less than 1% of traffic is routed to baseline models.',
  'If anomaly is detected, traffic is redirected first, then rollback is triggered.',
  'Reported rollback speed: 6.4 seconds for 113 GB parameters.',
];

const impactHighlights = [
  'Model-update latency reported at 2.4 seconds in OSDI 2022 deployment context.',
  'Update-path optimizations and storage scheduling helped push scaling from early 100x to later 10,000x model-size range.',
  'WeChat Channels DAU and VV growth (40% and 87% over six months) was reported alongside rollout, product iteration, and operations.',
  'Retrospective A/B tests reported 1.30% to 3.82% SLO gain in specific reranking-delay setups.',
];

const references = [
  { label: 'OSDI 2022 paper: Ekko', href: 'https://www.usenix.org/conference/osdi22/presentation/sima' },
  { label: 'WeChat official write-up', href: 'https://mp.weixin.qq.com/s/gBD3mdoRRlGI8bmXp2OBMA' },
  { label: 'Tencent official write-up', href: 'https://mp.weixin.qq.com/s/hS5ZebOC7oQz_Itud0A_Rg' },
  { label: 'Monolith (RecSys 2022)', href: '' },
  { label: 'Project Adam (OSDI 2014)', href: '' },
  { label: 'Slicer (OSDI 2016)', href: '' },
  { label: 'Meta freshness talk (AtScale 2025)', href: 'https://atscaleconference.com/model-freshness-systems-at-scale/' },
];
---
<BaseLayout>
  <a href="#main" class="skip-link">Skip to main content</a>

  <div
    id="scroll-progress"
    class="fixed top-0 left-0 right-0 h-1 z-[60] no-print"
    role="progressbar"
    aria-label="Page scroll progress"
    aria-valuemin="0"
    aria-valuemax="100"
    aria-valuenow="0"
  ></div>

  <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 no-print transition-transform duration-300" aria-label="Primary navigation">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8">
      <div id="nav-container" class="glass rounded-2xl mt-4 px-4 sm:px-6 py-3 transition-all duration-300 relative">
        <div class="flex items-center justify-between gap-4">
          <a href="/" class="flex items-center gap-3 group" aria-label="Back to overview page">
            <img
              src="/favicon.svg"
              data-asset-src="/favicon.svg"
              alt=""
              width="40"
              height="40"
              class="w-10 h-10 rounded-xl shadow-sm"
              loading="eager"
              decoding="async"
            />
            <div class="hidden sm:block">
              <span class="font-display font-semibold text-base block leading-tight">Ekko extended notes</span>
              <span class="text-xs text-neutral-500 dark:text-neutral-400">System deep dive</span>
            </div>
          </a>

          <div class="hidden lg:flex items-center gap-1">
            {
              navItems.map((item) => (
                <a
                  href={item.href}
                  class="nav-link px-3 py-2 rounded-lg text-sm font-medium text-neutral-600 dark:text-neutral-300 hover:text-primary-700 dark:hover:text-primary-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-200"
                >
                  {item.label}
                </a>
              ))
            }
            <a
              href="/cv.pdf"
              data-prefetch
              class="px-3 py-2 rounded-lg text-sm font-medium text-neutral-600 dark:text-neutral-300 hover:text-primary-700 dark:hover:text-primary-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-200"
            >
              CV PDF
            </a>
          </div>

          <div class="flex items-center gap-2">
            <button
              id="theme-toggle"
              class="relative p-2.5 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-200 focus-ring"
              aria-label="Toggle dark mode"
              aria-pressed="false"
            >
              <i data-lucide="sun" class="w-5 h-5 absolute inset-0 m-auto transition-all duration-300 rotate-0 scale-100 dark:-rotate-90 dark:scale-0 text-primary-500"></i>
              <i data-lucide="moon" class="w-5 h-5 absolute inset-0 m-auto transition-all duration-300 rotate-90 scale-0 dark:rotate-0 dark:scale-100 text-secondary-400"></i>
              <span class="w-5 h-5 block opacity-0" aria-hidden="true">.</span>
            </button>

            <button
              id="share-button"
              class="relative p-2.5 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all duration-200 focus-ring"
              aria-label="Share this page"
              type="button"
            >
              <i data-lucide="share-2" class="w-5 h-5 text-neutral-600 dark:text-neutral-300"></i>
            </button>

            <button
              id="mobile-menu-btn"
              class="lg:hidden p-2.5 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-colors focus-ring"
              aria-label="Toggle menu"
              aria-controls="mobile-menu"
              aria-expanded="false"
            >
              <i data-lucide="menu" class="w-5 h-5 menu-icon"></i>
              <i data-lucide="x" class="w-5 h-5 close-icon hidden"></i>
            </button>
          </div>
        </div>

        <div id="mobile-menu" class="hidden lg:hidden absolute left-0 right-0 top-full mt-3 rounded-2xl glass shadow-xl p-4" hidden>
          <div class="grid sm:grid-cols-2 gap-2">
            {
              navItems.map((item) => (
                <a href={item.href} class="mobile-nav-link px-4 py-3 rounded-xl text-sm font-medium text-neutral-600 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all flex items-center gap-2">
                  <i data-lucide={item.icon} class="w-4 h-4 text-primary-600"></i>
                  {item.label}
                </a>
              ))
            }
            <a href="/cv.pdf" data-prefetch class="mobile-nav-link px-4 py-3 rounded-xl text-sm font-medium text-neutral-600 dark:text-neutral-300 hover:bg-neutral-100 dark:hover:bg-neutral-800 transition-all flex items-center gap-2">
              <i data-lucide="file-text" class="w-4 h-4 text-primary-600"></i>
              CV PDF
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main id="main" tabindex="-1">
    <section class="pt-32 pb-16 lg:pt-36 lg:pb-20 bg-neutral-50 dark:bg-neutral-950" aria-labelledby="ekko-extended-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <p class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800 text-sm text-neutral-600 dark:text-neutral-400 mb-5">
            Extra page
          </p>
          <h1 id="ekko-extended-heading" class="text-4xl sm:text-5xl font-display font-bold leading-tight mb-3">
            Ekko extended deep dive
          </h1>
          <p class="text-lg sm:text-xl text-neutral-600 dark:text-neutral-400 leading-relaxed max-w-4xl mb-7">
            Organized technical narrative from internal notes: challenge, design choices, dissemination, storage scheduling, safety, and production outcomes.
          </p>
          <div class="flex flex-wrap gap-3">
            <a href="/deep-dive" class="magnetic-btn inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-white dark:bg-neutral-900 text-neutral-800 dark:text-neutral-200 font-medium shadow-sm border border-neutral-200 dark:border-neutral-700 hover:border-neutral-300 dark:hover:border-neutral-500 transition-all focus-ring">
              <i data-lucide="arrow-left" class="w-5 h-5"></i>
              Back to technical notes
            </a>
            <a href="/" class="magnetic-btn inline-flex items-center gap-2 px-5 py-2.5 rounded-xl bg-neutral-900 dark:bg-neutral-100 text-white dark:text-neutral-900 font-medium shadow-sm hover:opacity-90 transition-all focus-ring">
              <i data-lucide="home" class="w-5 h-5"></i>
              Overview page
            </a>
          </div>
        </div>
      </div>
    </section>

    <section id="challenge" class="cv-auto py-16 lg:py-20 bg-white dark:bg-neutral-900" aria-labelledby="challenge-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="challenge-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">1) Motivation and scaling challenge</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 leading-relaxed max-w-4xl mb-8">
            Early scale-up improved offline metrics, but online engagement dropped because model updates became stale under non-stationary workloads.
          </p>

          <div class="grid lg:grid-cols-2 gap-5 mb-6 stagger">
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Workload context</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  scalingContext.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="dot" class="w-4 h-4 text-neutral-400 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Project targets</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  projectTargets.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="check-circle-2" class="w-4 h-4 text-secondary-500 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
          </div>

          <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
            <h3 class="text-xl font-display font-semibold mb-3">System model</h3>
            <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
              {
                systemModel.map((item) => (
                  <li class="flex items-start gap-2.5">
                    <i data-lucide="minus" class="w-4 h-4 text-neutral-400 mt-1 flex-shrink-0"></i>
                    <span>{item}</span>
                  </li>
                ))
              }
            </ul>
          </article>
        </div>
      </div>
    </section>

    <section id="pipeline" class="cv-auto py-16 lg:py-20 bg-neutral-50 dark:bg-neutral-950" aria-labelledby="pipeline-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="pipeline-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">2) Update pipeline diagram</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-8 max-w-4xl">
            Ekko shortens the update path by avoiding slow multi-step checkpoint and validation gates, then adding targeted safety control in inference.
          </p>
          <div class="grid lg:grid-cols-2 gap-5 stagger">
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
              <h3 class="text-xl font-display font-semibold mb-4">Traditional path</h3>
              <div class="space-y-2">
                {
                  traditionalPath.map((step, idx) => (
                    <div>
                      <div class="rounded-xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 px-4 py-3 text-sm font-medium">
                        {step}
                      </div>
                      {idx < traditionalPath.length - 1 && (
                        <div class="flex justify-center py-1.5">
                          <i data-lucide="arrow-down" class="w-4 h-4 text-neutral-400"></i>
                        </div>
                      )}
                    </div>
                  ))
                }
              </div>
            </article>
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
              <h3 class="text-xl font-display font-semibold mb-4">Ekko path</h3>
              <div class="space-y-2">
                {
                  ekkoPath.map((step, idx) => (
                    <div>
                      <div class="rounded-xl border border-primary-200 dark:border-primary-800/60 bg-primary-50 dark:bg-primary-900/20 px-4 py-3 text-sm font-medium">
                        {step}
                      </div>
                      {idx < ekkoPath.length - 1 && (
                        <div class="flex justify-center py-1.5">
                          <i data-lucide="arrow-down" class="w-4 h-4 text-primary-500"></i>
                        </div>
                      )}
                    </div>
                  ))
                }
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>

    <section id="dissemination" class="cv-auto py-16 lg:py-20 bg-white dark:bg-neutral-900" aria-labelledby="dissemination-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="dissemination-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">3) P2P dissemination and DVV cache</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-8 max-w-4xl">
            Contribution 1 combines leaderless version-vector synchronization with workload-aware caching to reduce anti-entropy overhead under sparse hot updates.
          </p>

          <div class="grid lg:grid-cols-2 gap-5 mb-6 stagger">
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Design highlights</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  disseminationHighlights.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="check-circle-2" class="w-4 h-4 text-secondary-500 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Reported results</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  disseminationStats.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="activity" class="w-4 h-4 text-primary-600 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
          </div>

          <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
            <h3 class="text-xl font-display font-semibold mb-4">Diagram: VV exchange with hot-parameter cache</h3>
            <svg
              viewBox="0 0 920 300"
              class="w-full h-auto text-neutral-700 dark:text-neutral-200"
              role="img"
              aria-labelledby="p2p-diagram-title p2p-diagram-desc"
            >
              <title id="p2p-diagram-title">P2P synchronization diagram</title>
              <desc id="p2p-diagram-desc">Server A and Server B exchange version vectors and compare only hot cached keys while DVV summarizes the rest.</desc>
              <defs>
                <marker id="arrow-sync" markerWidth="8" markerHeight="8" refX="7" refY="3.5" orient="auto">
                  <polygon points="0 0, 7 3.5, 0 7" fill="currentColor"></polygon>
                </marker>
              </defs>

              <rect x="40" y="60" width="220" height="170" rx="14" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="150" y="95" text-anchor="middle" font-size="18" font-weight="600" fill="currentColor">Server A</text>
              <text x="150" y="126" text-anchor="middle" font-size="14" fill="currentColor">VV_A</text>
              <text x="150" y="150" text-anchor="middle" font-size="14" fill="currentColor">Hot cache keys</text>
              <text x="150" y="174" text-anchor="middle" font-size="14" fill="currentColor">DVV summary</text>

              <rect x="660" y="60" width="220" height="170" rx="14" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="770" y="95" text-anchor="middle" font-size="18" font-weight="600" fill="currentColor">Server B</text>
              <text x="770" y="126" text-anchor="middle" font-size="14" fill="currentColor">VV_B</text>
              <text x="770" y="150" text-anchor="middle" font-size="14" fill="currentColor">Hot cache keys</text>
              <text x="770" y="174" text-anchor="middle" font-size="14" fill="currentColor">DVV summary</text>

              <rect x="325" y="108" width="270" height="84" rx="12" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="460" y="140" text-anchor="middle" font-size="14" fill="currentColor">Compare VV only on cached keys</text>
              <text x="460" y="164" text-anchor="middle" font-size="14" fill="currentColor">Complexity shifts: O(N) -> O(Nr)</text>

              <line x1="260" y1="120" x2="325" y2="120" stroke="currentColor" stroke-width="2" marker-end="url(#arrow-sync)"></line>
              <line x1="660" y1="180" x2="595" y2="180" stroke="currentColor" stroke-width="2" marker-end="url(#arrow-sync)"></line>
              <text x="292" y="110" text-anchor="middle" font-size="12" fill="currentColor">VV exchange</text>
              <text x="627" y="200" text-anchor="middle" font-size="12" fill="currentColor">Needed updates only</text>
            </svg>
          </article>
        </div>
      </div>
    </section>

    <section id="scheduler" class="cv-auto py-16 lg:py-20 bg-neutral-50 dark:bg-neutral-950" aria-labelledby="scheduler-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="scheduler-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">4) SLO-aware update prioritization</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-8 max-w-4xl">
            Contribution 2 schedules updates by impact instead of sending every update immediately. This reduces WAN pressure while preserving online quality.
          </p>

          <div class="grid lg:grid-cols-3 gap-5 mb-6 stagger">
            {
              schedulerSignals.map((item) => (
                <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
                  <h3 class="text-lg font-display font-semibold mb-2">{item.title}</h3>
                  <p class="text-neutral-600 dark:text-neutral-400">{item.detail}</p>
                </article>
              ))
            }
          </div>

          <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
            <h3 class="text-xl font-display font-semibold mb-3">Priority formulation (high-level)</h3>
            <p class="text-neutral-600 dark:text-neutral-400 mb-4">
              A practical scoring view is:
            </p>
            <pre class="rounded-xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-4 text-sm overflow-x-auto"><code>priorityScore = freshnessSignal + gradientSignal + modelTrafficSignal</code></pre>
            <ul class="mt-4 space-y-2 text-neutral-700 dark:text-neutral-300">
              {
                schedulerOutcomes.map((item) => (
                  <li class="flex items-start gap-2.5">
                    <i data-lucide="gauge" class="w-4 h-4 text-primary-600 mt-1 flex-shrink-0"></i>
                    <span>{item}</span>
                  </li>
                ))
              }
            </ul>
          </article>
        </div>
      </div>
    </section>

    <section id="storage" class="cv-auto py-16 lg:py-20 bg-white dark:bg-neutral-900" aria-labelledby="storage-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="storage-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">5) SLO-aware shard manager (storage)</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-8 max-w-4xl">
            Contribution 3 uses optimization-based scheduling to balance resource efficiency, inference latency, and operational stability under dynamic traffic.
          </p>

          <div class="grid lg:grid-cols-2 gap-5 mb-6 stagger">
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Optimization objectives</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  storageObjectives.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="minus" class="w-4 h-4 text-neutral-400 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Solver acceleration and outcomes</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  storageOutcomes.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="database-zap" class="w-4 h-4 text-primary-600 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
          </div>

          <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6">
            <h3 class="text-xl font-display font-semibold mb-3">MILP framing (simplified)</h3>
            <pre class="rounded-xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-4 text-sm overflow-x-auto"><code>minimize: migrationCost + overloadPenalty(cpu, mem, net) + spanPenalty
subject to:
  each scheduling unit is assigned once
  per-node quota constraints are respected
  model span is bounded for low-latency inference
  migration pressure remains under an operation threshold</code></pre>
          </article>
        </div>
      </div>
    </section>

    <section id="safety" class="cv-auto py-16 lg:py-20 bg-neutral-50 dark:bg-neutral-950" aria-labelledby="safety-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="safety-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">6) Inference model state manager</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-8 max-w-4xl">
            Contribution 4 protects online quality after skipping validation by detecting harmful updates and rolling back rapidly.
          </p>

          <div class="grid lg:grid-cols-2 gap-5 mb-6 stagger">
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Common anomaly triggers</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  safetyTriggers.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="alert-triangle" class="w-4 h-4 text-amber-500 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
            <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
              <h3 class="text-xl font-display font-semibold mb-3">Safety outcomes</h3>
              <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
                {
                  safetyOutcomes.map((item) => (
                    <li class="flex items-start gap-2.5">
                      <i data-lucide="shield-check" class="w-4 h-4 text-secondary-500 mt-1 flex-shrink-0"></i>
                      <span>{item}</span>
                    </li>
                  ))
                }
              </ul>
            </article>
          </div>

          <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-6">
            <h3 class="text-xl font-display font-semibold mb-4">Diagram: safety control path</h3>
            <svg
              viewBox="0 0 980 220"
              class="w-full h-auto text-neutral-700 dark:text-neutral-200"
              role="img"
              aria-labelledby="safety-diagram-title safety-diagram-desc"
            >
              <title id="safety-diagram-title">Model safety rollback path</title>
              <desc id="safety-diagram-desc">Monitor online and baseline models, detect anomaly, reroute traffic, and rollback parameters.</desc>
              <defs>
                <marker id="arrow-safe" markerWidth="8" markerHeight="8" refX="7" refY="3.5" orient="auto">
                  <polygon points="0 0, 7 3.5, 0 7" fill="currentColor"></polygon>
                </marker>
              </defs>

              <rect x="20" y="70" width="180" height="90" rx="12" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="110" y="106" text-anchor="middle" font-size="14" fill="currentColor">Monitor online</text>
              <text x="110" y="128" text-anchor="middle" font-size="14" fill="currentColor">and baseline models</text>

              <rect x="240" y="70" width="180" height="90" rx="12" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="330" y="106" text-anchor="middle" font-size="14" fill="currentColor">Anomaly detector</text>
              <text x="330" y="128" text-anchor="middle" font-size="14" fill="currentColor">flags corruption</text>

              <rect x="460" y="70" width="180" height="90" rx="12" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="550" y="106" text-anchor="middle" font-size="14" fill="currentColor">Redirect traffic</text>
              <text x="550" y="128" text-anchor="middle" font-size="14" fill="currentColor">to safe alternative</text>

              <rect x="680" y="70" width="130" height="90" rx="12" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="745" y="116" text-anchor="middle" font-size="14" fill="currentColor">Rollback</text>

              <rect x="840" y="70" width="120" height="90" rx="12" fill="none" stroke="currentColor" stroke-width="2"></rect>
              <text x="900" y="116" text-anchor="middle" font-size="14" fill="currentColor">Serve</text>

              <line x1="200" y1="115" x2="240" y2="115" stroke="currentColor" stroke-width="2" marker-end="url(#arrow-safe)"></line>
              <line x1="420" y1="115" x2="460" y2="115" stroke="currentColor" stroke-width="2" marker-end="url(#arrow-safe)"></line>
              <line x1="640" y1="115" x2="680" y2="115" stroke="currentColor" stroke-width="2" marker-end="url(#arrow-safe)"></line>
              <line x1="810" y1="115" x2="840" y2="115" stroke="currentColor" stroke-width="2" marker-end="url(#arrow-safe)"></line>
            </svg>
          </article>
        </div>
      </div>
    </section>

    <section id="impact" class="cv-auto py-16 lg:py-20 bg-white dark:bg-neutral-900" aria-labelledby="impact-heading">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal">
          <h2 id="impact-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">7) Deployment impact and interpretation</h2>
          <p class="text-lg text-neutral-600 dark:text-neutral-400 mb-8 max-w-4xl">
            Reported outcomes indicate large operational gains. Some product metrics should be read as rollout-correlated rather than purely system-caused.
          </p>

          <article class="rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 p-6 mb-6">
            <h3 class="text-xl font-display font-semibold mb-3">Selected outcomes</h3>
            <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
              {
                impactHighlights.map((item) => (
                  <li class="flex items-start gap-2.5">
                    <i data-lucide="check-circle-2" class="w-4 h-4 text-secondary-500 mt-1 flex-shrink-0"></i>
                    <span>{item}</span>
                  </li>
                ))
              }
            </ul>
          </article>

          <article class="rounded-2xl border border-amber-200 dark:border-amber-800/60 bg-amber-50 dark:bg-amber-900/20 p-6">
            <h3 class="text-xl font-display font-semibold mb-3">Caveat on attribution</h3>
            <p class="text-neutral-700 dark:text-neutral-300 leading-relaxed">
              The DAU and VV growth numbers were reported in the same period as Ekko rollout, while product iteration and operations were also ongoing. This page presents those figures as contextual outcomes, not as single-cause attribution.
            </p>
          </article>
        </div>
      </div>
    </section>

    <section id="references" class="cv-auto py-16 lg:py-20 bg-neutral-50 dark:bg-neutral-950" aria-labelledby="references-heading">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="reveal rounded-2xl border border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-900 p-8">
          <h2 id="references-heading" class="text-3xl sm:text-4xl font-display font-bold mb-4">8) References and evidence</h2>
          <p class="text-neutral-600 dark:text-neutral-400 mb-6">
            Primary paper and public write-ups, followed by related systems context mentioned in the notes.
          </p>
          <div class="flex flex-wrap gap-3 mb-4">
            {
              references
                .filter((item) => item.href)
                .map((item) => (
                  <a
                    href={item.href}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl border border-neutral-200 dark:border-neutral-700 bg-neutral-50 dark:bg-neutral-800/40 hover:border-neutral-300 dark:hover:border-neutral-500 transition-colors text-sm font-medium"
                  >
                    {item.label}
                    <i data-lucide="external-link" class="w-4 h-4"></i>
                  </a>
                ))
            }
          </div>
          <ul class="space-y-2 text-neutral-700 dark:text-neutral-300">
            {
              references
                .filter((item) => !item.href)
                .map((item) => (
                  <li class="flex items-start gap-2.5">
                    <i data-lucide="book-open" class="w-4 h-4 text-neutral-400 mt-1 flex-shrink-0"></i>
                    <span>{item.label}</span>
                  </li>
                ))
            }
          </ul>
        </div>
      </div>
    </section>
  </main>

  <footer class="bg-neutral-900 text-white py-12 no-print" role="contentinfo">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-5">
        <div>
          <p class="font-display font-semibold text-lg">Chijun Sima</p>
          <p class="text-neutral-400 text-sm">Ekko extended technical notes.</p>
        </div>
        <div class="flex flex-wrap gap-2">
          <a href="/" class="px-3 py-1.5 rounded-lg bg-neutral-800 text-sm hover:bg-neutral-700 transition-colors">Overview page</a>
          <a href="/deep-dive" class="px-3 py-1.5 rounded-lg bg-neutral-800 text-sm hover:bg-neutral-700 transition-colors">Technical notes</a>
          <a href="#dissemination" class="px-3 py-1.5 rounded-lg bg-neutral-800 text-sm hover:bg-neutral-700 transition-colors">Dissemination</a>
          <a href="#safety" class="px-3 py-1.5 rounded-lg bg-neutral-800 text-sm hover:bg-neutral-700 transition-colors">Safety</a>
          <a href="/cv.pdf" data-prefetch class="px-3 py-1.5 rounded-lg bg-neutral-800 text-sm hover:bg-neutral-700 transition-colors">CV PDF</a>
        </div>
      </div>
      <div class="pt-6 mt-6 border-t border-neutral-800 flex flex-col sm:flex-row justify-between items-center gap-3">
        <p class="text-neutral-400 text-sm">Â© <span id="year"></span> Chijun Sima. All rights reserved.</p>
        <a href="#top" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-neutral-800 hover:bg-neutral-700 text-sm transition-colors">
          <i data-lucide="arrow-up" class="w-4 h-4"></i>
          Back to top
        </a>
      </div>
    </div>
  </footer>

  <div id="pwa-toast" class="pwa-toast" role="status" aria-live="polite" hidden>
    <div class="pwa-toast__content">
      <p id="pwa-toast-title" class="pwa-toast__title">Update available</p>
      <p id="pwa-toast-desc" class="pwa-toast__desc">Refresh to load the latest version.</p>
    </div>
    <div class="pwa-toast__actions">
      <button id="pwa-toast-action" class="pwa-toast__btn pwa-toast__btn--primary" type="button">Update</button>
      <button id="pwa-toast-dismiss" class="pwa-toast__btn" type="button">Not now</button>
    </div>
  </div>
</BaseLayout>
